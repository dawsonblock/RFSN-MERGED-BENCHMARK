name: RFSN AutoFix (Governed)

on:
  workflow_dispatch:
    inputs:
      goal:
        description: "What should RFSN do?"
        required: true
        default: "Fix failing tests"
      verify:
        description: "Verify command"
        required: true
        default: "pytest -q"

jobs:
  rfsn:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Build RFSN Docker image
        run: docker build -t rfsn-coding:latest .

      - name: Run RFSN (docker sandbox, governed)
        env:
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          mkdir -p artifacts
          GOAL="${{ github.event.inputs.goal }}"
          VERIFY="${{ github.event.inputs.verify }}"
          rfsn --profile ci_safe --repo "$PWD" --goal "$GOAL" --verify "$VERIFY" || true

      - name: Generate summary
        run: |
          python scripts/rfsn_pr_summary.py \
            --repo "$PWD" \
            --events "artifacts/events.jsonl" \
            --goal "${{ github.event.inputs.goal }}" \
            --out "artifacts/RFSN_SUMMARY.md"

      - name: Publish artifacts (local)
        env:
          RFSN_SIGNING_KEY: ${{ secrets.RFSN_SIGNING_KEY }}
        run: |
          python scripts/rfsn_publish_artifacts.py \
            --artifacts artifacts \
            --publish-backend local \
            --publish-local-dir artifacts/published

      - name: Append audit log
        run: |
          python scripts/rfsn_audit_append.py \
            --repo "$PWD" \
            --goal "${{ github.event.inputs.goal }}" \
            --profile "ci_safe" \
            --status "complete" \
            --artifacts "artifacts" \
            --log "artifacts/audit_log.jsonl"

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: rfsn-run
          path: artifacts/
