name: RFSN Benchmark (Strict)

on:
    workflow_dispatch:
        inputs:
            dataset:
                description: "Dataset to evaluate"
                required: false
                default: "swebench_lite.jsonl"
                type: choice
                options:
                    - swebench_lite.jsonl
                    - swebench_verified.jsonl
                    - swebench_full.jsonl
            max_tasks:
                description: "Maximum tasks to run (blank for all)"
                required: false
                type: string
    pull_request:
        branches: [main]
        paths:
            - "eval/**"
            - "orchestrator/**"
            - "agent/**"
            - "rfsn_controller/**"

env:
    RFSN_STRICT_BENCH: "1"

jobs:
    verify-datasets:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4

            - name: Verify datasets
              run: python scripts/verify_datasets.py

    benchmark:
        runs-on: ubuntu-latest
        needs: verify-datasets
        timeout-minutes: 180

        steps:
            - uses: actions/checkout@v4

            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"
                  cache: "pip"

            - name: Install dependencies
              run: pip install -e ".[dev]"

            - name: Restore learning state
              uses: actions/cache@v4
              with:
                  path: .rfsn_state
                  key: rfsn-learning-${{ github.ref_name }}-${{ github.run_number }}
                  restore-keys: |
                      rfsn-learning-${{ github.ref_name }}-
                      rfsn-learning-main-
                      rfsn-learning-

            - name: Run benchmark
              env:
                  DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
                  GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
              run: |
                  ARGS=""
                  if [ -n "${{ inputs.max_tasks }}" ]; then
                    ARGS="--max-tasks ${{ inputs.max_tasks }}"
                  fi
                  python -m eval.run_v2 --dataset ${{ inputs.dataset || 'swebench_lite.jsonl' }} $ARGS

            - name: Save learning state
              uses: actions/cache/save@v4
              if: always()
              with:
                  path: .rfsn_state
                  key: rfsn-learning-${{ github.ref_name }}-${{ github.run_number }}

            - name: Upload results
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: eval-results
                  path: eval_results/
                  retention-days: 30

            - name: Upload learning state
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: learning-state
                  path: .rfsn_state/
                  retention-days: 30
