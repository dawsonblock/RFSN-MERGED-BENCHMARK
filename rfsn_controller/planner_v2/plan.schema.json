{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://rfsn.dev/schemas/plan.schema.json",
    "title": "RFSN Planner v2 Schema",
    "description": "Formal schema for Plan and Step structures in the RFSN Planner v2",
    "definitions": {
        "StepStatus": {
            "type": "string",
            "enum": [
                "PENDING",
                "ACTIVE",
                "DONE",
                "FAILED",
                "SKIPPED",
                "BLOCKED",
                "HALTED"
            ],
            "description": "Lifecycle status of a step"
        },
        "RiskLevel": {
            "type": "string",
            "enum": [
                "LOW",
                "MED",
                "HIGH"
            ],
            "description": "Risk classification affecting budgets and verification"
        },
        "FailureCategory": {
            "type": "string",
            "enum": [
                "TEST_REGRESSION",
                "TEST_TIMEOUT",
                "COMPILATION_ERROR",
                "TYPE_ERROR",
                "LINT_ERROR",
                "IMPORT_ERROR",
                "RUNTIME_ERROR",
                "SANDBOX_VIOLATION",
                "HYGIENE_VIOLATION",
                "ALLOWLIST_VIOLATION",
                "BUDGET_EXCEEDED",
                "MISSING_DEPENDENCY",
                "CONFIGURATION_ERROR",
                "FLAKY_TEST",
                "UNKNOWN"
            ],
            "description": "Structured failure classification for revision decisions"
        },
        "Step": {
            "type": "object",
            "required": [
                "step_id",
                "title",
                "intent",
                "allowed_files",
                "success_criteria"
            ],
            "properties": {
                "step_id": {
                    "type": "string",
                    "pattern": "^[a-z0-9-]+$",
                    "description": "Immutable identifier for this step"
                },
                "title": {
                    "type": "string",
                    "maxLength": 100,
                    "description": "Human-readable step title"
                },
                "intent": {
                    "type": "string",
                    "maxLength": 500,
                    "description": "What this step aims to accomplish"
                },
                "allowed_files": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "minItems": 1,
                    "maxItems": 10,
                    "description": "Files this step may read/write (strict allowlist)"
                },
                "dependencies": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [],
                    "description": "step_ids that must complete before this step"
                },
                "inputs": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [],
                    "description": "Named outputs from prior steps this step consumes"
                },
                "success_criteria": {
                    "type": "string",
                    "description": "How to determine if step succeeded"
                },
                "verify": {
                    "type": "string",
                    "description": "Command or recipe to verify success"
                },
                "risk_level": {
                    "$ref": "#/definitions/RiskLevel",
                    "default": "LOW"
                },
                "retry_limit": {
                    "type": "integer",
                    "minimum": 0,
                    "maximum": 3,
                    "default": 2,
                    "description": "Max retries before marking FAILED"
                },
                "rollback_hint": {
                    "type": "string",
                    "description": "How to undo this step if needed"
                },
                "status": {
                    "$ref": "#/definitions/StepStatus",
                    "default": "PENDING"
                },
                "failure_count": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 0
                },
                "controller_task_spec": {
                    "type": "object",
                    "description": "Opaque payload passed to controller"
                }
            },
            "additionalProperties": false
        },
        "HaltCondition": {
            "type": "object",
            "properties": {
                "max_consecutive_failures": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 3
                },
                "identical_failure_threshold": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 2
                },
                "file_growth_threshold_kb": {
                    "type": "integer",
                    "minimum": 0,
                    "default": 1000
                },
                "flaky_streak_threshold": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 3
                }
            }
        },
        "BudgetLimits": {
            "type": "object",
            "properties": {
                "max_patch_cycles": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 15
                },
                "max_step_failures": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 10
                },
                "max_tokens": {
                    "type": "integer",
                    "minimum": 1000,
                    "default": 100000
                },
                "max_time_seconds": {
                    "type": "integer",
                    "minimum": 60,
                    "default": 1800
                }
            }
        },
        "Plan": {
            "type": "object",
            "required": [
                "plan_id",
                "goal",
                "steps"
            ],
            "properties": {
                "plan_id": {
                    "type": "string",
                    "description": "Unique identifier for this plan"
                },
                "goal": {
                    "type": "string",
                    "description": "High-level goal this plan achieves"
                },
                "assumptions": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [],
                    "description": "Assumptions made during decomposition"
                },
                "constraints": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": [],
                    "description": "Hard constraints on execution"
                },
                "created_at": {
                    "type": "string",
                    "format": "date-time"
                },
                "version": {
                    "type": "integer",
                    "minimum": 1,
                    "default": 1
                },
                "budget_limits": {
                    "$ref": "#/definitions/BudgetLimits"
                },
                "halt_conditions": {
                    "$ref": "#/definitions/HaltCondition"
                },
                "steps": {
                    "type": "array",
                    "items": {
                        "$ref": "#/definitions/Step"
                    },
                    "minItems": 1,
                    "maxItems": 20,
                    "description": "Ordered sequence of atomic steps"
                }
            },
            "additionalProperties": false
        },
        "ControllerOutcome": {
            "type": "object",
            "required": [
                "step_id",
                "success"
            ],
            "properties": {
                "step_id": {
                    "type": "string"
                },
                "success": {
                    "type": "boolean"
                },
                "tests_passed": {
                    "type": "boolean"
                },
                "touched_files": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "diff_hash": {
                    "type": "string"
                },
                "error_message": {
                    "type": "string"
                },
                "metrics": {
                    "type": "object",
                    "properties": {
                        "tokens_used": {
                            "type": "integer"
                        },
                        "duration_ms": {
                            "type": "integer"
                        },
                        "patch_cycles": {
                            "type": "integer"
                        }
                    }
                },
                "failure_evidence": {
                    "type": "object",
                    "properties": {
                        "category": {
                            "$ref": "#/definitions/FailureCategory"
                        },
                        "top_failing_tests": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "maxItems": 5
                        },
                        "stack_trace_head": {
                            "type": "string",
                            "maxLength": 500
                        },
                        "error_line": {
                            "type": "integer"
                        },
                        "error_codes": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "affected_files": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            }
                        },
                        "suggestion": {
                            "type": "string"
                        }
                    }
                }
            }
        },
        "PlanState": {
            "type": "object",
            "required": [
                "plan_id"
            ],
            "properties": {
                "plan_id": {
                    "type": "string"
                },
                "current_step_id": {
                    "type": "string"
                },
                "completed_steps": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "failed_steps": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    }
                },
                "halted": {
                    "type": "boolean",
                    "default": false
                },
                "halt_reason": {
                    "type": "string"
                },
                "total_tokens_used": {
                    "type": "integer",
                    "default": 0
                },
                "total_patch_cycles": {
                    "type": "integer",
                    "default": 0
                }
            }
        }
    },
    "type": "object",
    "$ref": "#/definitions/Plan"
}